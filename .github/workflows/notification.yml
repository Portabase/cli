name: Release Notification

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RELEASE_TITLE: "${{ github.event.release.name }}"
          RELEASE_URL: "${{ github.event.release.html_url }}"
          RELEASE_BODY: "${{ github.event.release.body }}"
          AUTHOR_NAME: "${{ github.event.release.author.login }}"
          AUTHOR_ICON: "${{ github.event.release.author.avatar_url }}"
        run: |
          PAYLOAD=$(jq -n \
            --arg title "$RELEASE_TITLE" \
            --arg description "$RELEASE_BODY" \
            --arg url "$RELEASE_URL" \
            --arg author "$AUTHOR_NAME" \
            --arg icon "$AUTHOR_ICON" \
            '{
              content: "||@everyone|| New release published",
              embeds: [{
                title: $title,
                url: $url,
                description: $description,
                color: 5814783,
                author: {
                  name: $author,
                  icon_url: $icon
                },
                footer: {
                  text: "Portabase"
                }
              }]
            }'
          )
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK"